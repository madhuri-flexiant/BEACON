package com.flexiant;

import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.logging.Level;
import java.util.logging.Logger;

public class FCOListener {
    private static FCOListener instance  = new FCOListener();;
    private static ServerSocket listener = null;
	private static final int PORT = 8341;
    private static Logger LOGGER;

    private FCOListener() {
        
    }

    public static FCOListener getInstance(Logger logger) {
    	LOGGER = logger;
    	try {
            listener = new ServerSocket(PORT);
        } catch (IOException e) {
        	LOGGER.log(Level.SEVERE, "Bind Issues", e);
        }
        return instance;
    }

    public void readFromSocket() {
        Socket socket = null;
        InputStream inStream = null;
        OutputStream outStream = null;

        try {
            socket = listener.accept();
            inStream = socket.getInputStream();
            outStream = new FileOutputStream("/home/user/ubuntu/VMDeatils.txt");
            
            // Not expecting the file to be any larger than 1KB
            byte[] bytes = new byte[1024];
            int count;
            while ((count = inStream.read(bytes)) > 0) {
            	outStream.write(bytes, 0, count);
            }
        } catch (FileNotFoundException e) {
        	LOGGER.log(Level.SEVERE, "File Path not found ", e);
        	
        } catch (IOException e) {
        	LOGGER.log(Level.SEVERE, "Error in socket connection ", e);
        	
        } finally {
        	try {
	        	if (outStream != null) {
					outStream.close();
	        	}
	        	if (inStream != null) {
	        		inStream.close();
	        	}
	        	if (socket != null) {
	        		socket.close();
	        	}
	        	if (listener != null) {
	        		listener.close();
	        	}
        	} catch (IOException e) {
        		LOGGER.log(Level.SEVERE, "Failed to close connection", e);
			}
        }
    }
}

