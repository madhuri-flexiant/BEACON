package com.flexiant;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;

import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import org.w3c.dom.Document;

/**
 * This runnable runs a scan on a VM and gets the report. 
 * The report obtained is stored as a Document and is emailed to the user as an attachment.
 * @author mramannavar
 *
 */
public class ExecuteScan implements Runnable {

	protected static String PATH_TO_REPORTS = "/home/ubuntu/reports/";
	private static Logger LOGGER = LogManager.getLogger(ExecuteScan.class);
	private HashMap<String, String> request = null;
	
	// Store the report in the same location with name - IP.xml 
    private void storeReport(Document xml, String ip) {
    	String file = PATH_TO_REPORTS + ip + ".xml";
    	
		try {
			TransformerFactory transformerFactory = TransformerFactory.newInstance();
			Transformer transformer = transformerFactory.newTransformer();
			DOMSource source = new DOMSource(xml);
			StreamResult result = new StreamResult(new File(file));
			transformer.transform(source, result);
			
		} catch (TransformerConfigurationException e) {
			e.printStackTrace();
		} catch (TransformerException e) {
			e.printStackTrace();
		}
    }
    
	public ExecuteScan(HashMap<String, String> request) {
		this.request = request;
	}

	@Override
	public void run()  {

        Scanner scanner = new Scanner(request);
        try {
        String reportId = scanner.startScanning();
        Document xmlDoc = scanner.getReport(reportId);
        LOGGER.info("XML document generated");
        
        storeReport(xmlDoc, request.get("IP"));
        EmailSystem es = new EmailSystem();
        es.sendEmail(request.get("ServerUUID"), request.get("IP"), request.get("EmailID"));
        } catch (ScannerException e) {
			LOGGER.error("Something went wrong in scanner", e);
			
		} catch (InterruptedException e) {
			LOGGER.error("Something went wrong with the scanner", e);
			
		} catch (IOException e) {
			LOGGER.error("Failed to get the report", e);
		} 
	}
}
